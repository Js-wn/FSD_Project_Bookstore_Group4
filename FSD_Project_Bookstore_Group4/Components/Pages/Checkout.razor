@page "/Checkout"
@attribute [StreamRendering]
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using FSD_Project_Bookstore_Group4.Domain
@using Microsoft.AspNetCore.Identity
@using FSD_Project_Bookstore_Group4.Data
@inject NavigationManager Navigation
@inject IDbContextFactory<FSD_Project_Bookstore_Group4.Data.FSD_Project_Bookstore_Group4Context> DbFactory
@rendermode InteractiveServer
@inject UserManager<FSD_Project_Bookstore_Group4User> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Checkout</PageTitle>

<h1>Checkout</h1>

@if (CartItems.Count > 0)
{
    <div>
        <h2>Your Cart</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Book</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in CartItems)
                {
                    <tr>
                        <td>@item.Book.BookTitle</td>
                        <td>
                            <InputNumber @bind-Value="item.OrderQty" />
                        </td>
                        <td>$@(item.Book.BookPrice * item.OrderQty)</td>
                        <td>
                            <button class="btn btn-danger" @onclick="() => RemoveFromCart(item.BookId)">Remove</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <button class="btn btn-success" @onclick="ProceedToPayment">Proceed to Payment</button>
    </div>
}
else
{
    <p>Your cart is empty.</p>
}

@code {
    private List<OrderItem> CartItems = new();
    private FSD_Project_Bookstore_Group4Context context;
    private Order? cartOrder;

    protected override async Task OnInitializedAsync()
    {
        context = await DbFactory.CreateDbContextAsync();

        // Get the currently logged-in user's ID
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = UserManager.GetUserId(user);

        if (string.IsNullOrEmpty(userId))
        {
            // If no user is logged in, return early
            return;
        }

        // Retrieve the customer using the logged-in user's ID
        var customer = await context.Customer.FirstOrDefaultAsync(c => c.AuthCustId == userId);

        if (customer == null)
        {
            // If no matching customer is found, return early
            return;
        }

        // Fetch the cart for the logged-in user
        cartOrder = await context.Order
            .Include(o => o.OrderItems)
            .ThenInclude(oi => oi.Book)
            .FirstOrDefaultAsync(o => o.CustomerId == customer.Id && o.IsInCart == "Yes");

        // If a cart exists, populate the CartItems list
        if (cartOrder != null)
        {
            CartItems = cartOrder.OrderItems.ToList();
        }
    }


    private async Task RemoveFromCart(int bookId)
    {
        var itemToRemove = CartItems.FirstOrDefault(i => i.BookId == bookId);
        if (itemToRemove != null)
        {
            CartItems.Remove(itemToRemove);
            context.OrderItem.Remove(itemToRemove);
            await context.SaveChangesAsync();
        }
    }

    private void ProceedToPayment()
    {
        double totalPrice = CartItems.Sum(item => item.Book.BookPrice * item.OrderQty);
        Navigation.NavigateTo($"/PaymentPage?totalPrice={totalPrice}");
    }

    public async ValueTask DisposeAsync()
    {
        if (context != null)
            await context.DisposeAsync();
    }
}
