@page "/Checkout"
@attribute [StreamRendering]
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using FSD_Project_Bookstore_Group4.Domain
@using FSD_Project_Bookstore_Group4.Data
@inject NavigationManager Navigation
@inject IDbContextFactory<FSD_Project_Bookstore_Group4.Data.FSD_Project_Bookstore_Group4Context> DbFactory
@rendermode InteractiveServer

<PageTitle>Checkout</PageTitle>

<h1>Checkout</h1>

@if (CartItems.Count > 0)
{
    <div>
        <h2>Your Cart</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Book</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in CartItems)
                {
                    <tr>
                        <td>@item.Book.BookTitle</td>
                        <td>
                            <InputNumber @bind-Value="item.OrderQty" />
                        </td>
                        <td>$@(item.Book.BookPrice * item.OrderQty)</td>
                        <td>
                            <button class="btn btn-danger" @onclick="() => RemoveFromCart(item.BookId)">Remove</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        <button class="btn btn-success" @onclick="ConfirmOrder">Checkout</button>
    </div>
}
else
{
    <p>Your cart is empty.</p>
}

@code {
    private List<OrderItem> CartItems = new();
    private FSD_Project_Bookstore_Group4Context context;
    private Order? cartOrder;

    protected override async Task OnInitializedAsync()
    {
        context = await DbFactory.CreateDbContextAsync();
        cartOrder = await context.Order.Include(o => o.OrderItems).ThenInclude(oi => oi.Book)
            .FirstOrDefaultAsync(o => o.CustomerId == 1 && o.IsInCart == "Yes");

        if (cartOrder != null)
        {
            CartItems = cartOrder.OrderItems.ToList();
        }
    }

    private async Task RemoveFromCart(int bookId)
    {
        var itemToRemove = CartItems.FirstOrDefault(i => i.BookId == bookId);
        if (itemToRemove != null)
        {
            CartItems.Remove(itemToRemove);
            context.OrderItem.Remove(itemToRemove);
            await context.SaveChangesAsync();
        }
    }

    private async Task ConfirmOrder()
    {
        if (cartOrder != null)
        {
            cartOrder.IsInCart = "No";
            await context.SaveChangesAsync();
        }

        Navigation.NavigateTo("/ThankYou");
    }

    public async ValueTask DisposeAsync()
    {
        if (context != null)
            await context.DisposeAsync();
    }
}
